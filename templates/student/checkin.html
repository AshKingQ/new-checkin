{% extends "base.html" %}

{% block title %}ç­¾åˆ° - å­¦ç”Ÿç­¾åˆ°ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="checkin-container">
    <div class="checkin-box">
        <h2>ç­¾åˆ°</h2>
        <p class="checkin-instruction">è¯·è¾“å…¥è€å¸ˆæä¾›çš„ç­¾åˆ°ç å®Œæˆç­¾åˆ°</p>
        
        <form method="POST" action="{{ url_for('student_checkin') }}" id="checkin-form">
            <div id="step-1" class="checkin-step">
                <div class="form-group">
                    <label for="code">ç­¾åˆ°ç </label>
                    <input type="text" id="code" name="code" required autofocus 
                           placeholder="è¯·è¾“å…¥ç­¾åˆ°ç " class="code-input"
                           {% if task %}value="{{ task.code }}"{% endif %}>
                </div>
                {% if not task %}
                <button type="button" class="btn btn-primary btn-large" onclick="verifyCodeAndGetLocation()">
                    <span class="icon">â†’</span>
                    ä¸‹ä¸€æ­¥
                </button>
                {% endif %}
            </div>
            
            {% if task %}
            <div id="step-2" class="checkin-step">
                <div class="location-info">
                    <h4>ğŸ“ ä½ç½®ä¿¡æ¯</h4>
                    <div id="location-status" class="status-message">æ­£åœ¨è·å–ä½ç½®...</div>
                    <div id="location-display" style="display:none;">
                        <p><strong>çº¬åº¦ï¼š</strong><span id="lat-display"></span></p>
                        <p><strong>ç»åº¦ï¼š</strong><span id="lng-display"></span></p>
                        <p><strong>ç²¾åº¦ï¼š</strong><span id="acc-display"></span> ç±³</p>
                    </div>
                </div>
                
                <div class="seat-selection">
                    <h4>ğŸª‘ è¯·é€‰æ‹©åº§ä½</h4>
                    <div class="seat-grid" id="seat-grid">
                        <!-- Seats will be generated by JavaScript -->
                    </div>
                    <div id="selected-seat-display" class="selected-seat-info" style="display:none;">
                        å·²é€‰æ‹©åº§ä½: <strong id="selected-seat-label"></strong>
                    </div>
                </div>
                
                <!-- Hidden fields for location and seat data -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="location_accuracy" name="location_accuracy">
                <input type="hidden" id="location_time" name="location_time">
                <input type="hidden" id="seat_row" name="seat_row">
                <input type="hidden" id="seat_col" name="seat_col">
                
                <button type="submit" class="btn btn-primary btn-large" id="submit-btn" disabled>
                    <span class="icon">âœ“</span>
                    ç¡®è®¤ç­¾åˆ°
                </button>
            </div>
            {% endif %}
        </form>
        
        <div class="checkin-tips">
            <h4>ç­¾åˆ°æç¤ºï¼š</h4>
            <ul>
                <li>è¯·ç¡®ä¿åœ¨ç­¾åˆ°æ—¶é—´èŒƒå›´å†…è¿›è¡Œç­¾åˆ°</li>
                <li>è¯·å…è®¸æµè§ˆå™¨è·å–ä½ç½®æƒé™</li>
                <li>è¯·é€‰æ‹©æ‚¨çš„å®é™…åº§ä½ä½ç½®</li>
                <li>æ¯ä¸ªç­¾åˆ°ä»»åŠ¡åªèƒ½ç­¾åˆ°ä¸€æ¬¡</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Configuration
const ROWS = ['A', 'B', 'C', 'D', 'E', 'F'];
const COLS = [1, 2, 3, 4, 5, 6, 7, 8];
let occupiedSeats = [];
let selectedSeat = null;
let locationObtained = false;

{% if task %}
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    getLocation();
    loadOccupiedSeats();
});

// Get geolocation
function getLocation() {
    if (navigator.geolocation) {
        document.getElementById('location-status').textContent = 'æ­£åœ¨è·å–ä½ç½®...';
        navigator.geolocation.getCurrentPosition(showPosition, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    } else {
        document.getElementById('location-status').textContent = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½';
        document.getElementById('location-status').style.color = '#e74c3c';
        locationObtained = true;
        checkFormReady();
    }
}

function showPosition(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const acc = position.coords.accuracy;
    const timestamp = new Date().toISOString();
    
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    document.getElementById('location_accuracy').value = acc;
    document.getElementById('location_time').value = timestamp;
    
    document.getElementById('lat-display').textContent = lat.toFixed(6);
    document.getElementById('lng-display').textContent = lng.toFixed(6);
    document.getElementById('acc-display').textContent = acc.toFixed(0);
    
    document.getElementById('location-status').style.display = 'none';
    document.getElementById('location-display').style.display = 'block';
    
    locationObtained = true;
    checkFormReady();
}

function handleLocationError(error) {
    let message = '';
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = 'æ‚¨æ‹’ç»äº†ä½ç½®æƒé™è¯·æ±‚ã€‚ç­¾åˆ°ä»å¯ç»§ç»­ï¼Œä½†ä¸ä¼šè®°å½•ä½ç½®ã€‚';
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ã€‚ç­¾åˆ°ä»å¯ç»§ç»­ã€‚';
            break;
        case error.TIMEOUT:
            message = 'è·å–ä½ç½®è¶…æ—¶ã€‚ç­¾åˆ°ä»å¯ç»§ç»­ã€‚';
            break;
        default:
            message = 'è·å–ä½ç½®å¤±è´¥ã€‚ç­¾åˆ°ä»å¯ç»§ç»­ã€‚';
            break;
    }
    document.getElementById('location-status').textContent = message;
    document.getElementById('location-status').style.color = '#f39c12';
    locationObtained = true;
    checkFormReady();
}

// Load occupied seats
function loadOccupiedSeats() {
    const code = document.getElementById('code').value;
    fetch(`/api/occupied_seats/{{ task.id }}?code=${encodeURIComponent(code)}`)
        .then(response => response.json())
        .then(data => {
            occupiedSeats = data;
            renderSeatGrid();
        })
        .catch(error => {
            console.error('Error loading occupied seats:', error);
            renderSeatGrid();
        });
}

// Render seat grid
function renderSeatGrid() {
    const grid = document.getElementById('seat-grid');
    grid.innerHTML = '';
    
    ROWS.forEach(row => {
        COLS.forEach(col => {
            const seatKey = `${row}${col}`;
            const isOccupied = occupiedSeats.some(s => s.seat_row === row && s.seat_col === col);
            
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.dataset.row = row;
            seat.dataset.col = col;
            seat.textContent = seatKey;
            
            if (isOccupied) {
                seat.classList.add('occupied');
                seat.title = 'è¯¥åº§ä½å·²è¢«å ç”¨';
            } else {
                seat.classList.add('available');
                seat.onclick = () => selectSeat(row, col, seat);
            }
            
            grid.appendChild(seat);
        });
    });
}

// Select seat
function selectSeat(row, col, element) {
    // Remove previous selection
    document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
    
    // Mark new selection
    element.classList.add('selected');
    selectedSeat = { row, col };
    
    document.getElementById('seat_row').value = row;
    document.getElementById('seat_col').value = col;
    
    document.getElementById('selected-seat-label').textContent = `${row}${col}`;
    document.getElementById('selected-seat-display').style.display = 'block';
    
    checkFormReady();
}

// Check if form is ready to submit
function checkFormReady() {
    const submitBtn = document.getElementById('submit-btn');
    if (selectedSeat && locationObtained) {
        submitBtn.disabled = false;
    }
}
{% endif %}

function verifyCodeAndGetLocation() {
    const code = document.getElementById('code').value.trim();
    if (!code) {
        alert('è¯·è¾“å…¥ç­¾åˆ°ç ');
        return;
    }
    // Submit form to verify code and proceed to next step
    document.getElementById('checkin-form').submit();
}
</script>
{% endblock %}
